# Virtual Tutor System - AI åŠ©æ‰‹ä¸Šä¸‹æ–‡æ–‡æ¡£

> æœ¬æ–‡æ¡£ä¸º AI åŠ©æ‰‹æä¾›é¡¹ç›®æ ¸å¿ƒä¸Šä¸‹æ–‡ï¼Œå¸®åŠ©å¿«é€Ÿç†è§£é¡¹ç›®ç»“æ„å’Œå…³é”®ä¿¡æ¯ã€‚

## ğŸ“š æ–‡æ¡£ç›®å½•

- [ğŸ“‹ é¡¹ç›®æ¦‚è¿°](#-é¡¹ç›®æ¦‚è¿°)
- [ğŸ—ï¸ ç³»ç»Ÿæ¶æ„](#ï¸-ç³»ç»Ÿæ¶æ„)
- [ğŸ› ï¸ æŠ€æœ¯æ ˆ](#ï¸-æŠ€æœ¯æ ˆ)
- [ğŸ” è®¤è¯ä¸æˆæƒ](#-è®¤è¯ä¸æˆæƒ)
- [ğŸ“¡ ä¸»è¦ API](#-ä¸»è¦-api)
- [ğŸ”§ å…³é”®é…ç½®](#-å…³é”®é…ç½®)
- [ğŸ—„ï¸ æ•°æ®åº“](#ï¸-æ•°æ®åº“)
- [ğŸ’¡ å…³é”®ä¿¡æ¯](#-å…³é”®ä¿¡æ¯)
- [ğŸ¯ GPU Server å¼€å‘é‡ç‚¹](#-gpu-server-å¼€å‘é‡ç‚¹)
- [ğŸ“¦ ä»£ç ç›®å½•è¯´æ˜å’Œæäº¤èŒƒå›´](#-ä»£ç ç›®å½•è¯´æ˜å’Œæäº¤èŒƒå›´)
- [ğŸš€ GPU Server å¿«é€Ÿå¼€å‘æŒ‡å—](#-gpu-server-å¿«é€Ÿå¼€å‘æŒ‡å—)
- [â“ å¸¸è§é—®é¢˜è§£ç­”](#-å¸¸è§é—®é¢˜è§£ç­”)
- [ğŸ“š å‚è€ƒèµ„æº](#-å‚è€ƒèµ„æº)

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

Virtual Tutor System æ˜¯ä¸€ä¸ªåŸºäº Sozio.AI çš„å¤šç§Ÿæˆ·è™šæ‹Ÿå¯¼å¸ˆå¹³å°ï¼Œç”¨äºä¸ºæ•™å¸ˆ/ç®¡ç†å‘˜åˆ›å»ºä¸“å±çš„ã€Œè™šæ‹Ÿå¯¼å¸ˆã€ï¼Œå¹¶é€šè¿‡å”¯ä¸€ URL åˆ†å‘ç»™å­¦ç”Ÿä½¿ç”¨ã€‚å­¦ç”Ÿé€šè¿‡å®æ—¶è¯­éŸ³/è§†é¢‘/æ–‡æœ¬ä¸ AI å¯¼å¸ˆäº’åŠ¨ã€‚

éœ€è¦ä¿ç•™å’Œæäº¤çš„ä»£ç ï¼š
gpuserver - GPUæœåŠ¡å™¨ä»£ç 
musetalk - MuseTalkç›¸å…³ä»£ç 
å‚è€ƒä»£ç ï¼ˆä¸æäº¤ï¼‰ï¼š
virtual-tutor - å½“å‰webserverçš„å‚è€ƒå®ç°
try - aiçš„å‚è€ƒå®ç°ï¼ˆä¸èƒ½ç…§æ¬ï¼‰
MuseTalkå¯ä»¥ä¿ç•™ - ä¸éœ€è¦åˆ é™¤

### ğŸ¤– AI åŠ©æ‰‹è§’è‰²è¯´æ˜

**å½“å‰è§’è‰²ï¼šGPU Server å¼€å‘è€…**

- **æˆ‘çš„ä»»åŠ¡**ï¼šå‚ç…§ `try/` ç›®å½•ä¸‹çš„å‚è€ƒä»£ç ï¼Œå¼€å‘å®Œæ•´çš„ GPU Server å®ç°ï¼Œå¹¶ä¸å‰ç«¯æˆåŠŸå¯¹æ¥
- **å‚è€ƒä»£ç **ï¼š`try/` ç›®å½•æ˜¯å®Œå…¨å¯è¿è¡Œçš„å‚è€ƒå®ç°ï¼Œ**ä¸è¦ä¿®æ”¹å®ƒ**ï¼Œä»…ä½œä¸ºå‚è€ƒ
- **å·¥ä½œç›®æ ‡**ï¼š
  1. å®ç° GPU Server çš„ç®¡ç† API (Port 9000)
  2. å®ç° GPU Server çš„ WebSocket å®æ—¶æ¥å£ (Port 9001)
  3. å®ç°ä¼šè¯ç®¡ç†å’Œ AI æ¨¡å‹æ¨ç†é€»è¾‘
  4. ç¡®ä¿ä¸å‰ç«¯å®Œå…¨å¯¹æ¥ï¼Œå®ç°ç«¯åˆ°ç«¯çš„å®æ—¶å¯¹è¯åŠŸèƒ½

### æ ¸å¿ƒç‰¹æ€§

- **å¤šç§Ÿæˆ·æ¶æ„**ï¼šAdmin â†’ Tutor â†’ Student ä¸‰çº§ç»“æ„
- **å®æ—¶å¯¹è¯**ï¼šæ”¯æŒæ–‡æœ¬ã€è¯­éŸ³ã€è§†é¢‘å¤šç§äº¤äº’æ–¹å¼
- **RAG çŸ¥è¯†åº“**ï¼šæ¯ä¸ª Tutor å¯ä¸Šä¼ ä¸“å±æ–‡æ¡£ï¼Œæ”¯æŒçŸ¥è¯†æ£€ç´¢
- **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´è®°å½•æ‰€æœ‰ç®¡ç†æ“ä½œå’Œä¼šè¯å†å²
- **æƒé™éš”ç¦»**ï¼šä¸¥æ ¼çš„å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„ï¼ˆåŒæœåŠ¡å™¨æ¶æ„ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Server A                            â”‚
â”‚                  (Web Server)                           â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Web Front-end                           â”‚ â”‚
â”‚  â”‚         React + Material-UI                         â”‚ â”‚
â”‚  â”‚            Port 3000                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Web Back-end                            â”‚ â”‚
â”‚  â”‚      FastAPI + SQLAlchemy                           â”‚ â”‚
â”‚  â”‚            Port 8000                               â”‚ â”‚
â”‚  â”‚  (æ§åˆ¶é¢ï¼šè®¤è¯ã€ä¼šè¯ç®¡ç†ã€RAG)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â”‚ HTTP API               â”‚ WebSocket/WebRTC
         â”‚ (ç®¡ç†æ¥å£)              â”‚ (å®æ—¶å¯¹è¯ï¼Œç›´è¿)
         â”‚                        â”‚
         â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Serverless                            â”‚
â”‚                  (GPU Server)                            â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AI Infer     â”‚  â”‚ AI Infer     â”‚  â”‚ AI Infer     â”‚ â”‚
â”‚  â”‚ Engine       â”‚  â”‚ Engine       â”‚  â”‚ Engine       â”‚ â”‚
â”‚  â”‚ (Active)     â”‚  â”‚ (Standby)    â”‚  â”‚ (Standby)    â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ - LLM        â”‚  â”‚ - LLM        â”‚  â”‚ - LLM        â”‚ â”‚
â”‚  â”‚ - ASR        â”‚  â”‚ - ASR        â”‚  â”‚ - ASR        â”‚ â”‚
â”‚  â”‚ - TTS        â”‚  â”‚ - TTS        â”‚  â”‚ - TTS        â”‚ â”‚
â”‚  â”‚ - MuseTalk   â”‚  â”‚ - MuseTalk   â”‚  â”‚ - MuseTalk   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  Management API: Port 9000                               â”‚
â”‚  WebSocket: Port 9001                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

#### 1. æ§åˆ¶é¢ï¼ˆManagement APIï¼‰

**Web Server â†’ GPU Server ç®¡ç† API**

```
1. Web Server éœ€è¦åˆ›å»ºä¼šè¯
   â†“
2. POST http://gpu-server:9000/v1/sessions
   {
     "tutor_id": 1,
     "student_id": 123,
     "kb_id": "kb-001"  // å¯é€‰
   }
   â†“
3. GPU Server åˆ›å»ºä¼šè¯å¹¶è¿”å›
   {
     "session_id": "uuid",
     "engine_url": "ws://gpu-server:9000/ws/ws/uuid",
     "engine_token": "token",
     "status": "active"
   }
   â†“
4. Web Server å°† engine_url å’Œ engine_token è¿”å›ç»™å‰ç«¯
```

#### 2. æ•°æ®é¢ï¼ˆWebSocket å®æ—¶å¯¹è¯ï¼‰

**å‰ç«¯ â†’ GPU Server WebSocket**

```
1. å‰ç«¯ä½¿ç”¨ engine_url å’Œ engine_token å»ºç«‹ WebSocket è¿æ¥
   ws://gpu-server:9000/ws/ws/{session_id}?token={engine_token}
   â†“
2. GPU Server éªŒè¯ token å¹¶æ¥å—è¿æ¥
   â†“
3. å®æ—¶å¯¹è¯å¾ªç¯ï¼š

   å‰ç«¯å‘é€ï¼š
   {"type": "text", "content": "ä½ å¥½"}

   GPU Server å¤„ç†ï¼š
   - è·å–å¯¹åº” tutor_id çš„ AI å¼•æ“
   - è°ƒç”¨ LLM ç”Ÿæˆå“åº”
   - ï¼ˆå¦‚æœæœ‰ kb_idï¼Œå¯è¿›è¡Œ RAG æ£€ç´¢ï¼‰

   GPU Server è¿”å›ï¼š
   {"type": "text", "content": "ä½ å¥½ï¼æˆ‘æ˜¯...", "role": "assistant"}

   æˆ–è€…ï¼ˆéŸ³é¢‘æ¨¡å¼ï¼‰ï¼š
   å‰ç«¯å‘é€ï¼š{"type": "audio", "data": "base64..."}
   GPU Serverï¼šASR â†’ LLM â†’ TTS
   GPU Server è¿”å›ï¼š{"type": "audio", "content": "...", "data": "base64..."}
```

#### 3. ä¼šè¯ç»“æŸ

```
Web Server è°ƒç”¨ï¼š
DELETE http://gpu-server:9000/v1/sessions/{session_id}
â†“
GPU Server æ¸…ç†ä¼šè¯èµ„æº
- ä» SessionManager ä¸­åˆ é™¤
- æ¸…ç† token æ˜ å°„
- ï¼ˆå¯é€‰ï¼‰æ¸…ç† AI å¼•æ“å®ä¾‹
```

### æœåŠ¡å™¨è¯´æ˜

- **Server A (Web Server)**ï¼šå‰ç«¯ + åç«¯ï¼Œæ§åˆ¶é¢ï¼Œè´Ÿè´£è®¤è¯ã€ç®¡ç†ã€æ•°æ®å­˜å‚¨
- **Serverless (GPU Server)**ï¼šå¤šä¸ª AI æ¨ç†å¼•æ“å®ä¾‹ï¼Œæ•°æ®é¢ï¼Œå¤„ç†å®æ—¶æ¨ç†

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### Web Serverï¼ˆServer Aï¼‰
- **åç«¯**ï¼šFastAPI 0.122.0 + SQLAlchemy 2.0.44 + SQLite/PostgreSQL
- **å‰ç«¯**ï¼šReact 19.1.0 + Material-UI 7.1.2
- **èŒè´£**ï¼šç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†ã€ä¼šè¯ç®¡ç†ã€æ•°æ®æŒä¹…åŒ–ã€å®¡è®¡æ—¥å¿—

### GPU Serverï¼ˆServerlessï¼‰
- **æ¡†æ¶**ï¼šFastAPI 0.115.0 + Uvicorn 0.32.0 + WebSockets 13.1
- **AI æ¨¡å‹é›†æˆ**ï¼š
  - **LLM**ï¼šOllamaï¼ˆé€šè¿‡ langchain-ollama é›†æˆï¼‰
    - æ”¯æŒæ¨¡å‹ï¼šMistral-Nemo, Llama 3.1, ç­‰
    - æ”¯æŒæŒ‰ tutor_id é…ç½®ä¸åŒæ¨¡å‹
  - **ASR**ï¼šå¾…é›†æˆï¼ˆå½“å‰ä¸º Mock å®ç°ï¼‰
  - **TTS**ï¼šå¾…é›†æˆï¼ˆå½“å‰ä¸º Mock å®ç°ï¼‰
  - **MuseTalk**ï¼šå¾…é›†æˆï¼ˆè§†é¢‘ç”Ÿæˆï¼‰
- **ä¾èµ–ç®¡ç†**ï¼š
  - Python 3.8+
  - Pydantic 2.10.0ï¼ˆæ•°æ®éªŒè¯ï¼‰
  - python-dotenv 1.0.1ï¼ˆç¯å¢ƒå˜é‡ç®¡ç†ï¼‰
  - httpx 0.27.0ï¼ˆHTTP å®¢æˆ·ç«¯ï¼‰
- **èŒè´£**ï¼šAI æ¨ç†ã€å®æ—¶å¯¹è¯å¤„ç†ã€WebSocket è¿æ¥ç®¡ç†

---

## ğŸ” è®¤è¯ä¸æˆæƒ

- **JWT Token**ï¼šå­˜å‚¨åœ¨ `localStorage.token`ï¼Œæ ¼å¼ `Bearer <token>`
- **ç”¨æˆ·è§’è‰²**ï¼š
  - Adminï¼š`POST /api/auth/login`ï¼Œç®¡ç†æ‰€æœ‰èµ„æº
  - Studentï¼š`POST /api/student/auth/login`ï¼Œè®¿é—®æŒ‡å®š Tutor

---

## ğŸ“¡ ä¸»è¦ API

### Web Server API

- è®¤è¯ï¼š`POST /api/auth/login`, `POST /api/student/auth/login`
- Tutor ç®¡ç†ï¼š`GET/POST/PUT/DELETE /api/tutors`
- å­¦ç”Ÿç®¡ç†ï¼š`GET/POST/PUT/DELETE /api/tutors/{tutor_id}/students`
- ä¼šè¯ç®¡ç†ï¼š`POST/GET /api/student/sessions`
- æ–‡æ¡£ç®¡ç†ï¼š`GET/POST/DELETE /api/tutors/{tutor_id}/documents`

### GPU Server API

- ç®¡ç†æ¥å£ï¼ˆWeb Server è°ƒç”¨ï¼‰ï¼š
  - `POST /v1/sessions` - åˆ›å»ºä¼šè¯ï¼Œè¿”å› `engine_url` + `engine_token`
  - `GET /v1/sessions/{id}` - æŸ¥è¯¢ä¼šè¯çŠ¶æ€
  - `DELETE /v1/sessions/{id}` - ç»“æŸä¼šè¯
- å®æ—¶æ¥å£ï¼ˆå‰ç«¯ç›´è¿ï¼‰ï¼š
  - `ws://gpu-server-ip:9001/ws/{session_id}?token={engine_token}` - WebSocket å®æ—¶å¯¹è¯

---

## ğŸ”§ å…³é”®é…ç½®

### Web Server åç«¯

```bash
# app_backend/.env
DATABASE_URL=sqlite:///./dev.db  # æˆ– postgresql://...
SECRET_KEY=your-secret-key
ENGINE_URL=http://gpu-server-ip:9000  # GPU Server åœ°å€
INIT_ADMIN_EMAIL=admin@example.com
INIT_ADMIN_PASSWORD=admin123
```

### GPU Server å®Œæ•´é…ç½®

```bash
# gpuserver/.env

# ========== æœåŠ¡å™¨é…ç½® ==========
# ç®¡ç† API é…ç½®
MANAGEMENT_API_HOST=0.0.0.0           # ç›‘å¬åœ°å€ï¼ˆ0.0.0.0 ç›‘å¬æ‰€æœ‰ç½‘å¡ï¼‰
MANAGEMENT_API_PORT=9000              # ç®¡ç† API ç«¯å£

# WebSocket é…ç½®
WEBSOCKET_HOST=0.0.0.0                # WebSocket ç›‘å¬åœ°å€
WEBSOCKET_PORT=9001                   # WebSocket ç«¯å£ï¼ˆç»Ÿä¸€æ¨¡å¼ä¸‹æœªä½¿ç”¨ï¼‰
WEBSOCKET_URL=ws://localhost:9001     # WebSocket å…¬ç½‘ URLï¼ˆç”¨äºè¿”å›ç»™å®¢æˆ·ç«¯ï¼‰

# ========== ä¼šè¯ç®¡ç†é…ç½® ==========
MAX_SESSIONS=10                       # æœ€å¤§å¹¶å‘ä¼šè¯æ•°
SESSION_TIMEOUT_SECONDS=3600          # ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1 å°æ—¶

# ========== GPU é…ç½® ==========
CUDA_VISIBLE_DEVICES=0                # ä½¿ç”¨çš„ GPU è®¾å¤‡ç¼–å·

# ========== LLM é…ç½® ==========
# Ollama æœåŠ¡åœ°å€
OLLAMA_BASE_URL=http://127.0.0.1:11434

# é»˜è®¤ LLM æ¨¡å‹ï¼ˆå¦‚æœæœªä¸ºç‰¹å®š tutor é…ç½®ï¼Œåˆ™ä½¿ç”¨æ­¤æ¨¡å‹ï¼‰
DEFAULT_LLM_MODEL=mistral-nemo:12b-instruct-2407-fp16

# LLM æ¸©åº¦å‚æ•°ï¼ˆ0.0-1.0ï¼Œæ§åˆ¶è¾“å‡ºéšæœºæ€§ï¼Œè¶Šé«˜è¶Šéšæœºï¼‰
LLM_TEMPERATURE=0.4

# æ˜¯å¦å¯ç”¨ LLMï¼ˆå¦‚æœä¸º falseï¼Œåˆ™ä½¿ç”¨ Mock æ¨¡å¼ï¼‰
ENABLE_LLM=true

# ========== æŒ‰ Tutor é…ç½®ä¸åŒæ¨¡å‹ï¼ˆå¯é€‰ï¼‰==========
# æ ¼å¼ï¼šTUTOR_{tutor_id}_LLM_MODEL=æ¨¡å‹åç§°
# ç¤ºä¾‹ï¼š
TUTOR_1_LLM_MODEL=mistral-nemo:12b-instruct-2407-fp16
TUTOR_2_LLM_MODEL=llama3.1:8b-instruct-q4_K_M
# TUTOR_3_LLM_MODEL=qwen2.5:7b-instruct-q4_K_M

# ========== ASR/TTS é…ç½®ï¼ˆå¾…å®ç°ï¼‰==========
# TODO: æ·»åŠ  ASR å’Œ TTS ç›¸å…³é…ç½®
```

### ç¯å¢ƒå˜é‡è¯´æ˜

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ | å¿…å¡« |
|--------|--------|------|------|
| `MANAGEMENT_API_HOST` | 0.0.0.0 | ç®¡ç† API ç›‘å¬åœ°å€ | å¦ |
| `MANAGEMENT_API_PORT` | 9000 | ç®¡ç† API ç«¯å£ | å¦ |
| `WEBSOCKET_HOST` | 0.0.0.0 | WebSocket ç›‘å¬åœ°å€ | å¦ |
| `WEBSOCKET_PORT` | 9001 | WebSocket ç«¯å£ï¼ˆç»Ÿä¸€æ¨¡å¼ä¸‹æœªä½¿ç”¨ï¼‰| å¦ |
| `WEBSOCKET_URL` | ws://localhost:9001 | è¿”å›ç»™å®¢æˆ·ç«¯çš„ WebSocket URL | æ˜¯ |
| `MAX_SESSIONS` | 10 | æœ€å¤§å¹¶å‘ä¼šè¯æ•° | å¦ |
| `SESSION_TIMEOUT_SECONDS` | 3600 | ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰| å¦ |
| `CUDA_VISIBLE_DEVICES` | 0 | GPU è®¾å¤‡ç¼–å· | å¦ |
| `OLLAMA_BASE_URL` | http://127.0.0.1:11434 | Ollama æœåŠ¡åœ°å€ | æ˜¯ï¼ˆå¦‚æœå¯ç”¨ LLMï¼‰|
| `DEFAULT_LLM_MODEL` | mistral-nemo:... | é»˜è®¤ LLM æ¨¡å‹ | æ˜¯ï¼ˆå¦‚æœå¯ç”¨ LLMï¼‰|
| `LLM_TEMPERATURE` | 0.4 | LLM æ¸©åº¦å‚æ•°ï¼ˆ0.0-1.0ï¼‰| å¦ |
| `ENABLE_LLM` | true | æ˜¯å¦å¯ç”¨ LLM | å¦ |
| `TUTOR_{id}_LLM_MODEL` | - | ä¸ºç‰¹å®š Tutor é…ç½®æ¨¡å‹ | å¦ |

### ç½‘ç»œé…ç½®åœºæ™¯

#### åœºæ™¯ 1ï¼šæœ¬åœ°å¼€å‘ï¼ˆåŒä¸€æœºå™¨ï¼‰

```bash
# Web Server .env
ENGINE_URL=http://127.0.0.1:9000

# GPU Server .env
MANAGEMENT_API_HOST=127.0.0.1
WEBSOCKET_URL=ws://127.0.0.1:9000
```

#### åœºæ™¯ 2ï¼šå±€åŸŸç½‘éƒ¨ç½²ï¼ˆä¸¤å°æœºå™¨ï¼‰

```bash
# Web Server .env
ENGINE_URL=http://192.168.1.100:9000  # GPU Server å†…ç½‘ IP

# GPU Server .env
MANAGEMENT_API_HOST=0.0.0.0
WEBSOCKET_URL=ws://192.168.1.100:9000
```

#### åœºæ™¯ 3ï¼šå…¬ç½‘éƒ¨ç½²ï¼ˆéœ€è¦å¼€æ”¾é˜²ç«å¢™ï¼‰

```bash
# Web Server .env
ENGINE_URL=http://gpu-public-ip:9000

# GPU Server .env
MANAGEMENT_API_HOST=0.0.0.0
WEBSOCKET_URL=ws://gpu-public-ip:9000

# é˜²ç«å¢™è®¾ç½®
sudo ufw allow 9000/tcp  # å¼€æ”¾ç®¡ç† API ç«¯å£
```

#### åœºæ™¯ 4ï¼šä½¿ç”¨ FRP å†…ç½‘ç©¿é€

```bash
# GPU Server .env.frpï¼ˆFRP é…ç½®ï¼‰
FRP_SERVER_ADDR=frp.example.com
FRP_SERVER_PORT=7000
FRP_TOKEN=your-frp-token
FRP_SUBDOMAIN=gpu-server

# Web Server .env
ENGINE_URL=http://gpu-server.frp.example.com:80
```

---

## ğŸ—„ï¸ æ•°æ®åº“

- **å¼€å‘ç¯å¢ƒ**ï¼šSQLite (`app_backend/dev.db`)
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šPostgreSQL
- **ä¸»è¦è¡¨**ï¼š`admins`, `tutors`, `students`, `sessions`, `chat_messages`, `tutor_documents`

---

## ğŸ’¡ å…³é”®ä¿¡æ¯

- **é»˜è®¤ç®¡ç†å‘˜**ï¼š`admin@example.com` / `admin123`
- **åˆå§‹åŒ–å‘½ä»¤**ï¼š`PYTHONPATH=/path/to/app_backend python -m app.initial_data`
- **API æ–‡æ¡£**ï¼š`http://localhost:8000/docs` (Swagger UI)
- **å¥åº·æ£€æŸ¥**ï¼š`http://localhost:8000/health` (Web Server), `http://gpu-server-ip:9000/health` (GPU Server)
- **å¼€å‘æ¨¡å¼**ï¼šä¸è®¾ç½® `ENGINE_URL` åˆ™ä½¿ç”¨ mockï¼Œä¸è¿æ¥çœŸå® GPU Server

---

## ğŸ¯ GPU Server å¼€å‘é‡ç‚¹

### æ¶æ„æ¨¡å¼

GPU Server é‡‡ç”¨**ç»Ÿä¸€æ¨¡å¼**ï¼ˆUnified Modeï¼‰è¿è¡Œï¼š
- æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨åŒä¸€è¿›ç¨‹ï¼ˆPort 9000ï¼‰
- ç®¡ç† API å’Œ WebSocket æœåŠ¡å…±äº« SessionManager
- ç»Ÿä¸€çš„ç«¯å£å’Œè·¯å¾„ç®¡ç†ï¼Œç®€åŒ–éƒ¨ç½²

### æ ¸å¿ƒæ¨¡å—

1. **unified_server.py**ï¼šä¸»å…¥å£ï¼Œé›†æˆæ‰€æœ‰æœåŠ¡
2. **management_api.py**ï¼šä¼šè¯ç®¡ç† REST API
3. **websocket_server.py**ï¼šå®æ—¶å¯¹è¯ WebSocket æœåŠ¡
4. **session_manager.py**ï¼šä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
5. **ai_models.py**ï¼šAI å¼•æ“æ¥å£å’Œæ¨¡å‹éš”ç¦»
6. **llm/llm_engine.py**ï¼šLLM é›†æˆï¼ˆOllamaï¼‰
7. **config.py**ï¼šé…ç½®ç®¡ç†

### å¿…é¡»å®ç°çš„æ¥å£

#### 1. ç®¡ç† APIï¼ˆPort 9000ï¼Œè·¯å¾„ï¼š`/mgmt/v1` æˆ–å…¼å®¹è·¯å¾„ `/v1`ï¼‰

| æ¥å£ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/health` | GET | å¥åº·æ£€æŸ¥ï¼Œè¿”å›æ´»è·ƒä¼šè¯æ•° |
| `/v1/sessions` æˆ– `/mgmt/v1/sessions` | POST | åˆ›å»ºä¼šè¯ |
| `/v1/sessions/{id}` | GET | æŸ¥è¯¢ä¼šè¯çŠ¶æ€ |
| `/v1/sessions/{id}` | DELETE | ç»“æŸä¼šè¯ |
| `/v1/sessions` | GET | åˆ—å‡ºæ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆè°ƒè¯•ç”¨ï¼‰|

**åˆ›å»ºä¼šè¯è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "tutor_id": 1,
  "student_id": 123,
  "kb_id": "kb-001"  // å¯é€‰
}
```

**åˆ›å»ºä¼šè¯å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "engine_url": "ws://localhost:9000/ws/ws/550e8400-e29b-41d4-a716-446655440000",
  "engine_token": "randomtoken123...",
  "status": "active"
}
```

#### 2. WebSocket å®æ—¶æ¥å£ï¼ˆPort 9000ï¼Œè·¯å¾„ï¼š`/ws/ws/{session_id}`ï¼‰

**è¿æ¥åœ°å€**ï¼š`ws://host:9000/ws/ws/{session_id}?token={engine_token}`

**å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ ¼å¼**ï¼š
```json
// æ–‡æœ¬æ¶ˆæ¯
{
  "type": "text",
  "content": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ Python"
}

// éŸ³é¢‘æ¶ˆæ¯
{
  "type": "audio",
  "data": "base64_encoded_audio_data"
}
```

**æœåŠ¡å™¨è¿”å›æ¶ˆæ¯æ ¼å¼**ï¼š
```json
// æ–‡æœ¬å“åº”
{
  "type": "text",
  "content": "ä½ å¥½ï¼Python æ˜¯ä¸€ç§...",
  "role": "assistant",
  "timestamp": "2025-12-23T10:00:00"
}

// éŸ³é¢‘è½¬å½•ç»“æœ
{
  "type": "transcription",
  "content": "è¿™æ˜¯è½¬å½•çš„æ–‡æœ¬",
  "role": "user",
  "timestamp": "2025-12-23T10:00:01"
}

// éŸ³é¢‘å“åº”ï¼ˆTTSï¼‰
{
  "type": "audio",
  "content": "æ–‡æœ¬å†…å®¹",
  "data": "base64_encoded_audio_data",
  "role": "assistant",
  "timestamp": "2025-12-23T10:00:02"
}

// é”™è¯¯æ¶ˆæ¯
{
  "type": "error",
  "content": "é”™è¯¯æè¿°",
  "timestamp": "2025-12-23T10:00:03"
}
```

### å…³é”®ç‰¹æ€§

1. **æŒ‰ Tutor éš”ç¦»æ¨¡å‹**
   - æ¯ä¸ª tutor_id å¯¹åº”ç‹¬ç«‹çš„ AIEngine å®ä¾‹
   - æ”¯æŒä¸åŒ tutor ä½¿ç”¨ä¸åŒçš„ LLM æ¨¡å‹
   - é€šè¿‡ç¯å¢ƒå˜é‡ `TUTOR_{tutor_id}_LLM_MODEL` é…ç½®

2. **ä¼šè¯ç®¡ç†**
   - æœ€å¤§å¹¶å‘ä¼šè¯æ•°é™åˆ¶ï¼ˆé»˜è®¤ 10ï¼‰
   - ä¼šè¯è¶…æ—¶è‡ªåŠ¨æ¸…ç†ï¼ˆé»˜è®¤ 1 å°æ—¶ï¼‰
   - Token è®¤è¯å’ŒéªŒè¯

3. **LLM é›†æˆ**
   - åŸºäº Ollama çš„ LLM è°ƒç”¨
   - æ”¯æŒ Mock æ¨¡å¼é™çº§
   - å¼‚æ­¥å¤„ç†ï¼Œæé«˜å¹¶å‘æ€§èƒ½

### å…³é”®èŒè´£

- âœ… **å¿…é¡»åš**ï¼šAI æ¨¡å‹æ¨ç†ï¼ˆLLM/ASR/TTS/MuseTalkï¼‰ã€å®æ—¶å¯¹è¯å¤„ç†ã€ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âŒ **ä¸è¦åš**ï¼šç”¨æˆ·è®¤è¯ã€æ•°æ®æŒä¹…åŒ–ã€å®¡è®¡æ—¥å¿—ï¼ˆè¿™äº›ç”± Web Server è´Ÿè´£ï¼‰

### ä¸ Web Server çš„äº¤äº’

- Web Server è°ƒç”¨ç®¡ç† API åˆ›å»ºä¼šè¯ï¼Œè·å– `engine_url` å’Œ `engine_token`
- å‰ç«¯ç›´è¿ WebSocket è¿›è¡Œå®æ—¶å¯¹è¯ï¼ˆä½¿ç”¨ `engine_url` å’Œ `engine_token`ï¼‰
- GPU Server åªéªŒè¯ `engine_token`ï¼Œä¸åšå®Œæ•´çš„ç”¨æˆ·è®¤è¯

### å®ç°è¿›åº¦

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ğŸŸ¢ **ç»Ÿä¸€æœåŠ¡å™¨** | âœ… å·²å®ç° | `unified_server.py` - å•è¿›ç¨‹è¿è¡Œï¼Œå…±äº« SessionManager |
| ğŸŸ¢ **ç®¡ç† API** | âœ… å·²å®ç° | ä¼šè¯ CRUDã€å¥åº·æ£€æŸ¥ã€è·¯å¾„å…¼å®¹å±‚ |
| ğŸŸ¢ **WebSocket æœåŠ¡** | âœ… å·²å®ç° | å®æ—¶å¯¹è¯ã€Token è®¤è¯ã€æ¶ˆæ¯å¤„ç† |
| ğŸŸ¢ **ä¼šè¯ç®¡ç†** | âœ… å·²å®ç° | ä¼šè¯åˆ›å»º/åˆ é™¤ã€Token éªŒè¯ã€è¶…æ—¶æ¸…ç† |
| ğŸŸ¢ **LLM é›†æˆ** | âœ… å·²å®ç° | Ollama + langchain-ollamaï¼Œæ”¯æŒå¤šæ¨¡å‹ |
| ğŸŸ¢ **æ¨¡å‹éš”ç¦»** | âœ… å·²å®ç° | æŒ‰ tutor_id éš”ç¦» AIEngine å®ä¾‹ |
| ğŸŸ¢ **å‰åç«¯è”è°ƒ** | âœ… å·²å®Œæˆ | GPU Server (9000) + Web Server (8000) + Frontend (3000) å·²æ‰“é€š |
| ğŸŸ¡ **ASR é›†æˆ** | ğŸš§ Mock | å¾…é›†æˆçœŸå® ASR æ¨¡å‹ï¼ˆWhisper ç­‰ï¼‰|
| ğŸŸ¡ **TTS é›†æˆ** | ğŸš§ Mock | å¾…é›†æˆçœŸå® TTS æ¨¡å‹ |
| ğŸŸ¡ **MuseTalk** | ğŸš§ å¾…é›†æˆ | è§†é¢‘ç”Ÿæˆæ¨¡å‹ï¼Œä»£ç å·²åœ¨ `/workspace/MuseTalk/` |
| ğŸŸ¡ **RAG æ£€ç´¢** | ğŸš§ å¾…å®ç° | çŸ¥è¯†åº“æ£€ç´¢ï¼Œé¢„ç•™äº†æ¥å£ |
| ğŸŸ¢ **æµ‹è¯•è„šæœ¬** | âœ… å·²å®Œæˆ | åŠŸèƒ½æµ‹è¯•ã€WebSocket æµ‹è¯•ã€LLM æµ‹è¯• |
| ğŸŸ¢ **éƒ¨ç½²è„šæœ¬** | âœ… å·²å®Œæˆ | å¯åŠ¨/åœæ­¢è„šæœ¬ã€FRP é›†æˆ |

**å›¾ä¾‹**ï¼š
- ğŸŸ¢ ç»¿è‰²ï¼šå·²å®Œæˆï¼Œå¯ç”¨äºç”Ÿäº§
- ğŸŸ¡ é»„è‰²ï¼šéƒ¨åˆ†å®Œæˆæˆ–å¾…é›†æˆ
- ğŸ”´ çº¢è‰²ï¼šæœªå¼€å§‹

**æœ€è¿‘æ›´æ–° (2025-12-24)**ï¼š
- âœ… è§£å†³äº†å‰ç«¯ WebSocket è¿æ¥é—®é¢˜ - å‰ç«¯æœåŠ¡æœªå¯åŠ¨å¯¼è‡´
- âœ… å¯åŠ¨äº†å‰ç«¯æœåŠ¡ (Port 3000)ï¼Œç¡®è®¤ä¸‰å±‚æœåŠ¡æ¶æ„æ­£å¸¸è¿è¡Œ
- âœ… éªŒè¯äº† GPU Server å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸å·¥ä½œ

---

## ğŸ“¦ ä»£ç ç›®å½•è¯´æ˜å’Œæäº¤èŒƒå›´

### ç›®å½•ç»“æ„

```
/workspace/
â”œâ”€â”€ MuseTalk/           # MuseTalk è§†é¢‘ç”Ÿæˆæ¨¡å‹ï¼ˆå¯ç”¨ï¼‰
â”‚   â””â”€â”€ ...             # âœ… å¯ä»¥æäº¤
â”‚
â”œâ”€â”€ gpuserver/          # GPU Server å®ç°ï¼ˆAI æ¨ç†å¼•æ“ï¼‰â­
â”‚   â”œâ”€â”€ unified_server.py           # ç»Ÿä¸€æœåŠ¡å™¨å…¥å£ï¼ˆæ¨èä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ management_api.py           # ç®¡ç† API æœåŠ¡
â”‚   â”œâ”€â”€ websocket_server.py         # WebSocket æœåŠ¡
â”‚   â”œâ”€â”€ session_manager.py          # ä¼šè¯ç®¡ç†å™¨
â”‚   â”œâ”€â”€ ai_models.py                # AI å¼•æ“æ¥å£å’Œæ¨¡å‹éš”ç¦»
â”‚   â”œâ”€â”€ config.py                   # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ requirements.txt            # Python ä¾èµ–
â”‚   â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚   â”œâ”€â”€ .env                        # å®é™…ç¯å¢ƒå˜é‡ï¼ˆä¸æäº¤ï¼‰
â”‚   â”œâ”€â”€ .env.frp                    # FRP é…ç½®ï¼ˆä¸æäº¤ï¼‰
â”‚   â”œâ”€â”€ frpc.ini                    # FRP å®¢æˆ·ç«¯é…ç½®
â”‚   â”œâ”€â”€ llm/                        # LLM æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ llm_engine.py           # LLM å¼•æ“å®ç°ï¼ˆOllama é›†æˆï¼‰
â”‚   â”‚   â””â”€â”€ README.md
â”‚   â”œâ”€â”€ temp/                       # ä¸´æ—¶æ–‡ä»¶å’Œè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ scripts/                # å¯åŠ¨ã€åœæ­¢ã€å®‰è£…è„šæœ¬
â”‚   â”‚   â”‚   â”œâ”€â”€ start.sh                    # åˆ†å¼€è¿è¡Œæ¨¡å¼å¯åŠ¨ï¼ˆå·²å¼ƒç”¨ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ start_server.sh             # å®¿ä¸»æœºç»Ÿä¸€æ¨¡å¼å¯åŠ¨ï¼ˆæ¨èï¼‰â­
â”‚   â”‚   â”‚   â”œâ”€â”€ start_llm_only.sh           # ä»…å¯åŠ¨ LLM æµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ start_frpc.sh               # å¯åŠ¨ FRP å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ start_with_frp.sh           # å¿«é€Ÿå¯åŠ¨ï¼ˆå¸¦ FRPï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ stop.sh                     # åœæ­¢æ‰€æœ‰æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ stop_server.sh              # åœæ­¢æœåŠ¡å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ stop_frpc.sh                # åœæ­¢ FRP å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ install_frpc.sh             # å®‰è£… FRP å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â””â”€â”€ test_connectivity.sh        # è¿é€šæ€§æµ‹è¯•è„šæœ¬
â”‚   â”‚   â””â”€â”€ tests/                  # æµ‹è¯•è„šæœ¬
â”‚   â”‚       â”œâ”€â”€ test_server.py              # åŠŸèƒ½æµ‹è¯•è„šæœ¬
â”‚   â”‚       â”œâ”€â”€ test_websocket.py           # WebSocket æµ‹è¯•è„šæœ¬
â”‚   â”‚       â””â”€â”€ test_llm.py                 # LLM æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ README.md               # GPU Server æ–‡æ¡£
â”‚                               # âœ… å¯ä»¥æäº¤
â”‚
â”œâ”€â”€ try/                # å‚è€ƒä»£ç ï¼ˆå®Œæ•´å¯è¿è¡Œçš„å®ç°ï¼‰
â”‚   â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ llm/
â”‚   â”œâ”€â”€ rag/
â”‚   â”œâ”€â”€ tts/
â”‚   â”œâ”€â”€ lip-sync/
â”‚   â””â”€â”€ ...             # âŒ ä»…ä¾›å‚è€ƒï¼Œä¸è¦ä¿®æ”¹ï¼Œä¸è¦æäº¤
â”‚
â””â”€â”€ virtual_tutor/      # Web Serverï¼ˆå‰ç«¯ + åç«¯ï¼‰
    â”œâ”€â”€ app_backend/
    â”œâ”€â”€ frontend/ (å¾…åˆ›å»º)
    â””â”€â”€ ...             # âŒ ä¸è¦æäº¤ï¼ˆåœ¨ webserver ä¸Šè¿è¡Œï¼‰
```

### GPU Server æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

#### ä¸»è¦ Python æ¨¡å—

| æ–‡ä»¶ | è¯´æ˜ | è¡Œæ•° |
|------|------|------|
| `unified_server.py` | ç»Ÿä¸€æœåŠ¡å™¨å…¥å£ï¼ŒæŒ‚è½½ç®¡ç† API å’Œ WebSocket æœåŠ¡ | ~145 |
| `management_api.py` | ç®¡ç† APIï¼Œå¤„ç†ä¼šè¯ CRUD æ“ä½œ | ~202 |
| `websocket_server.py` | WebSocket æœåŠ¡ï¼Œå¤„ç†å®æ—¶å¯¹è¯ | ~237 |
| `session_manager.py` | ä¼šè¯ç®¡ç†å™¨ï¼Œç®¡ç†ä¼šè¯ç”Ÿå‘½å‘¨æœŸ | ~186 |
| `ai_models.py` | AI å¼•æ“æ¥å£ï¼Œå°è£… LLM/ASR/TTS è°ƒç”¨ | ~223 |
| `config.py` | é…ç½®ç®¡ç†ï¼ŒåŸºäº Pydantic Settings | ~43 |
| `llm/llm_engine.py` | LLM å¼•æ“å®ç°ï¼ŒOllama é›†æˆ | ~192 |
| `llm/__init__.py` | LLM æ¨¡å—å¯¼å‡º | ~11 |

#### é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | æ˜¯å¦æäº¤ |
|------|------|----------|
| `.env.example` | ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼ŒåŒ…å«æ‰€æœ‰é…ç½®é¡¹ | âœ… æäº¤ |
| `.env` | å®é™…ç¯å¢ƒå˜é‡ï¼ŒåŒ…å«æ•æ„Ÿä¿¡æ¯ | âŒ ä¸æäº¤ |
| `.env.frp` | FRP é…ç½®ï¼ŒåŒ…å«æœåŠ¡å™¨åœ°å€å’Œ Token | âŒ ä¸æäº¤ |
| `frpc.ini` | FRP å®¢æˆ·ç«¯é…ç½®æ¨¡æ¿ | âœ… å¯æäº¤ |
| `.gitignore` | Git å¿½ç•¥è§„åˆ™ | âœ… æäº¤ |

#### è„šæœ¬æ–‡ä»¶

**æ¨èä½¿ç”¨**ï¼š
- `temp/scripts/start_server.sh`ï¼šå¯åŠ¨ç»Ÿä¸€æ¨¡å¼æœåŠ¡å™¨ï¼ˆå®¿ä¸»æœºç‰ˆæœ¬ï¼‰
- `temp/scripts/stop_server.sh`ï¼šåœæ­¢æœåŠ¡å™¨
- `temp/scripts/test_connectivity.sh`ï¼šæµ‹è¯•è¿é€šæ€§

**å…¶ä»–è„šæœ¬**ï¼š
- `temp/scripts/start_with_frp.sh`ï¼šå¿«é€Ÿå¯åŠ¨ï¼ˆå¸¦ FRPï¼‰
- `temp/scripts/start_llm_only.sh`ï¼šä»…å¯åŠ¨ LLM æµ‹è¯•
- `temp/scripts/install_frpc.sh`ï¼šå®‰è£… FRP å®¢æˆ·ç«¯

#### æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `temp/tests/test_server.py` | åŠŸèƒ½æµ‹è¯• | æµ‹è¯•ç®¡ç† API åŸºæœ¬åŠŸèƒ½ |
| `temp/tests/test_websocket.py` | WebSocket æµ‹è¯• | æµ‹è¯•å®æ—¶è¿æ¥å’Œæ¶ˆæ¯å¤„ç† |
| `temp/tests/test_llm.py` | LLM æµ‹è¯• | æµ‹è¯• LLM é›†æˆå’Œæ¨¡å‹éš”ç¦» |

### æäº¤èŒƒå›´è¯´æ˜

#### âœ… å¯ä»¥æäº¤çš„ç›®å½•

1. **`/workspace/MuseTalk/`**
   - MuseTalk æ¨¡å‹å·²ç»å¯ç”¨
   - ç”¨äºç”Ÿæˆå®æ—¶å¯¹è¯çš„è§†é¢‘
   - å¯ä»¥ç›´æ¥æäº¤åˆ° GPU Server ç¯å¢ƒ

2. **`/workspace/gpuserver/`**
   - è¿™æ˜¯ä½ å½“å‰å¼€å‘çš„ GPU Server å®ç°
   - åŒ…å«ç®¡ç† APIã€WebSocket æœåŠ¡ã€ä¼šè¯ç®¡ç†ã€AI æ¨¡å‹æ¥å£
   - å®Œæˆåå¯ä»¥æäº¤åˆ° GPU Server ç¯å¢ƒ

#### âŒ ä¸èƒ½æäº¤çš„ç›®å½•

1. **`/workspace/try/`**
   - è¿™æ˜¯å‚è€ƒä»£ç ï¼Œå®Œæ•´å¯è¿è¡Œçš„å®ç°ç¤ºä¾‹
   - **ä»…ä¾›å‚è€ƒå­¦ä¹ ï¼Œä¸è¦ä¿®æ”¹**
   - ç”¨äºç†è§£æ¶æ„å’Œæ¥å£è®¾è®¡
   - ä¸è¦æäº¤

2. **`/workspace/virtual_tutor/`**
   - Web Serverï¼ˆå‰ç«¯ + åç«¯ï¼‰çš„å®ç°
   - è¿è¡Œåœ¨ webserver ä¸Šï¼Œä¸åœ¨ GPU Server ç¯å¢ƒ
   - ä¸è¦æäº¤åˆ° GPU Server

### å·¥ä½œæµç¨‹

1. **å‚è€ƒ `try/` ç›®å½•**ï¼šå­¦ä¹ æ¥å£è®¾è®¡å’Œå®ç°æ¨¡å¼
2. **å¼€å‘ `gpuserver/` ç›®å½•**ï¼šå®ç°ç¬¦åˆæ¥å£è§„èŒƒçš„ GPU Server
3. **é›†æˆ `MuseTalk/` æ¨¡å‹**ï¼šåœ¨ AI æ¨ç†ä¸­ä½¿ç”¨ MuseTalk ç”Ÿæˆè§†é¢‘
4. **æµ‹è¯•ä¸ `virtual_tutor/` å¯¹æ¥**ï¼šç¡®ä¿æ¥å£å…¼å®¹ï¼Œèƒ½å¤Ÿä¸ Web Server é€šä¿¡
5. **æäº¤åˆ° GPU Server ç¯å¢ƒ**ï¼šä»…æäº¤ `gpuserver/` å’Œ `MuseTalk/`

---

**æœ€åæ›´æ–°**ï¼š2025-12-23

---

## ğŸš€ GPU Server å¿«é€Ÿå¼€å‘æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# è¿›å…¥ GPU Server ç›®å½•
cd /workspace/gpuserver

# ä½¿ç”¨ try ç›®å½•çš„ conda ç¯å¢ƒï¼ˆæ¨èï¼‰
export PATH="/workspace/conda_envs/rag/bin:$PATH"

# æˆ–è€…å®‰è£…ä¾èµ–åˆ°å½“å‰ç¯å¢ƒ
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œæ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®
vim .env
```

å…³é”®é…ç½®é¡¹ï¼š
- `MANAGEMENT_API_PORT=9000`ï¼šç®¡ç† API ç«¯å£
- `WEBSOCKET_URL=ws://localhost:9001`ï¼šWebSocket å…¬ç½‘ URL
- `OLLAMA_BASE_URL=http://127.0.0.1:11434`ï¼šOllama æœåŠ¡åœ°å€
- `DEFAULT_LLM_MODEL=mistral-nemo:12b-instruct-2407-fp16`ï¼šé»˜è®¤ LLM æ¨¡å‹
- `ENABLE_LLM=true`ï¼šæ˜¯å¦å¯ç”¨çœŸå® LLMï¼ˆfalse åˆ™ä½¿ç”¨ Mockï¼‰

### 3. å¯åŠ¨æœåŠ¡

**æ–¹å¼ä¸€ï¼šä½¿ç”¨è„šæœ¬å¯åŠ¨ï¼ˆæ¨èï¼‰**

```bash
# å¯åŠ¨ç»Ÿä¸€æ¨¡å¼æœåŠ¡å™¨
bash temp/scripts/start_server.sh
```

**æ–¹å¼äºŒï¼šç›´æ¥å¯åŠ¨**

```bash
# ä½¿ç”¨ rag conda ç¯å¢ƒ
/workspace/conda_envs/rag/bin/python unified_server.py

# æˆ–è€…è®¾ç½® PATH åå¯åŠ¨
export PATH="/workspace/conda_envs/rag/bin:$PATH"
python3 unified_server.py
```

### 4. æµ‹è¯•æœåŠ¡

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:9000/health

# æµ‹è¯•åˆ›å»ºä¼šè¯
curl -X POST http://localhost:9000/v1/sessions \
  -H "Content-Type: application/json" \
  -d '{"tutor_id": 1, "student_id": 123}'

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
python3 temp/tests/test_server.py
python3 temp/tests/test_websocket.py
python3 temp/tests/test_llm.py
```

### 5. åœæ­¢æœåŠ¡

```bash
# ä½¿ç”¨è„šæœ¬åœæ­¢
bash temp/scripts/stop_server.sh

# æˆ–è€…æ‰‹åŠ¨åœæ­¢
pkill -f "python.*unified_server.py"
```

---

## â“ å¸¸è§é—®é¢˜è§£ç­”

### Q1: LLM è°ƒç”¨å¤±è´¥ï¼Œå¦‚ä½•æ’æŸ¥ï¼Ÿ

**é—®é¢˜**ï¼šLLM è¿”å› Mock å“åº”ï¼Œæˆ–è€…å‡ºç°è¿æ¥é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ Ollama æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
   ```bash
   # æ£€æŸ¥ Ollama æœåŠ¡çŠ¶æ€
   curl http://127.0.0.1:11434/api/tags

   # å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨ Ollama
   ollama serve
   ```

2. ç¡®è®¤æ¨¡å‹å·²å®‰è£…ï¼š
   ```bash
   # åˆ—å‡ºå·²å®‰è£…çš„æ¨¡å‹
   ollama list

   # å®‰è£…æ¨¡å‹ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
   ollama pull mistral-nemo:12b-instruct-2407-fp16
   ```

3. æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼š
   ```bash
   # ç¡®è®¤ ENABLE_LLM=true
   grep ENABLE_LLM .env

   # ç¡®è®¤ OLLAMA_BASE_URL æ­£ç¡®
   grep OLLAMA_BASE_URL .env
   ```

4. æ£€æŸ¥ä¾èµ–ï¼š
   ```bash
   # ç¡®è®¤å®‰è£…äº† langchain-ollama
   pip list | grep langchain
   ```

### Q2: WebSocket è¿æ¥å¤±è´¥ï¼Œå¦‚ä½•æ’æŸ¥ï¼Ÿ

**é—®é¢˜**ï¼šWebSocket è¿æ¥è¢«æ‹’ç»æˆ–æ–­å¼€

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
   ```bash
   curl http://localhost:9000/health
   ```

2. ç¡®è®¤ WebSocket è·¯å¾„æ­£ç¡®ï¼š
   - ç»Ÿä¸€æ¨¡å¼ï¼š`ws://localhost:9000/ws/ws/{session_id}?token={token}`
   - æ³¨æ„ï¼šè·¯å¾„æ˜¯ `/ws/ws/`ï¼Œæœ‰ä¸¤ä¸ª `ws`

3. ç¡®è®¤ token æœ‰æ•ˆï¼š
   - å…ˆè°ƒç”¨ç®¡ç† API åˆ›å»ºä¼šè¯ï¼Œè·å– `engine_token`
   - ä½¿ç”¨è¿”å›çš„ `engine_token` è¿›è¡Œ WebSocket è¿æ¥

4. æŸ¥çœ‹æ—¥å¿—ï¼š
   ```bash
   # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
   tail -f gpuserver/logs/server.log
   ```

### Q3: å¦‚ä½•ä¸ºä¸åŒ Tutor é…ç½®ä¸åŒæ¨¡å‹ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```bash
# ä¸º Tutor 1 é…ç½®æ¨¡å‹
TUTOR_1_LLM_MODEL=mistral-nemo:12b-instruct-2407-fp16

# ä¸º Tutor 2 é…ç½®æ¨¡å‹
TUTOR_2_LLM_MODEL=llama3.1:8b-instruct-q4_K_M

# ä¸º Tutor 3 é…ç½®æ¨¡å‹
TUTOR_3_LLM_MODEL=qwen2.5:7b-instruct-q4_K_M
```

å¦‚æœæœªé…ç½®ç‰¹å®š Tutor çš„æ¨¡å‹ï¼Œåˆ™ä½¿ç”¨ `DEFAULT_LLM_MODEL`ã€‚

### Q4: ä¼šè¯æ•°è¾¾åˆ°ä¸Šé™ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ

**é—®é¢˜**ï¼šåˆ›å»ºä¼šè¯æ—¶è¿”å› 503 é”™è¯¯ï¼Œæç¤º "Maximum sessions reached"

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ æœ€å¤§ä¼šè¯æ•°é™åˆ¶ï¼š
   ```bash
   # åœ¨ .env ä¸­è®¾ç½®
   MAX_SESSIONS=20
   ```

2. æ¸…ç†è¿‡æœŸä¼šè¯ï¼š
   ```bash
   # ä¼šè¯ä¼šè‡ªåŠ¨æ¸…ç†ï¼Œæˆ–æ‰‹åŠ¨åˆ é™¤
   curl -X DELETE http://localhost:9000/v1/sessions/{session_id}
   ```

3. è°ƒæ•´ä¼šè¯è¶…æ—¶æ—¶é—´ï¼š
   ```bash
   # åœ¨ .env ä¸­è®¾ç½®ï¼ˆç§’ï¼‰
   SESSION_TIMEOUT_SECONDS=1800  # 30 åˆ†é’Ÿ
   ```

### Q5: å¦‚ä½•è°ƒè¯•å’ŒæŸ¥çœ‹æ—¥å¿—ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š
   ```bash
   # å¦‚æœä½¿ç”¨è„šæœ¬å¯åŠ¨ï¼Œæ—¥å¿—åœ¨ logs ç›®å½•
   tail -f gpuserver/logs/server.log
   ```

2. å¢åŠ æ—¥å¿—çº§åˆ«ï¼š
   åœ¨ä»£ç ä¸­ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼š
   ```python
   # åœ¨ websocket_server.py æˆ– management_api.py ä¸­
   logging.basicConfig(level=logging.DEBUG)
   ```

3. ä½¿ç”¨è°ƒè¯•æ¨¡å¼å¯åŠ¨ï¼š
   ```bash
   # ç›´æ¥å¯åŠ¨ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
   python3 unified_server.py
   ```

### Q6: å¦‚ä½•ä¸ Web Server å¯¹æ¥ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ç¡®è®¤ Web Server çš„ `ENGINE_URL` é…ç½®ï¼š
   ```bash
   # åœ¨ Web Server çš„ .env ä¸­è®¾ç½®
   ENGINE_URL=http://gpu-server-ip:9000
   ```

2. ç¡®è®¤ç½‘ç»œè¿é€šæ€§ï¼š
   ```bash
   # ä» Web Server æµ‹è¯•è¿æ¥
   curl http://gpu-server-ip:9000/health
   ```

3. ç¡®è®¤é˜²ç«å¢™è§„åˆ™ï¼š
   ```bash
   # å¼€æ”¾ç«¯å£ 9000
   sudo ufw allow 9000/tcp
   ```

4. ä½¿ç”¨ FRP è¿›è¡Œå†…ç½‘ç©¿é€ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   ```bash
   # é…ç½® .env.frp åå¯åŠ¨
   bash temp/scripts/start_with_frp.sh
   ```

### Q7: å¦‚ä½•æ·»åŠ æ–°çš„ AI æ¨¡å‹ï¼ˆASR/TTSï¼‰ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

ä¿®æ”¹ [ai_models.py](gpuserver/ai_models.py) ä¸­çš„å¯¹åº”æ–¹æ³•ï¼š

```python
async def process_audio(self, audio_data: str) -> str:
    """å¤„ç†éŸ³é¢‘è¾“å…¥ï¼ˆASR: è¯­éŸ³è½¬æ–‡æœ¬ï¼‰"""

    # TODO: é›†æˆçœŸå®çš„ ASR æ¨¡å‹
    # 1. è§£ç  base64 éŸ³é¢‘æ•°æ®
    audio_bytes = base64.b64decode(audio_data)

    # 2. è°ƒç”¨ ASR æ¨¡å‹
    # transcription = await self.asr_model.transcribe(audio_bytes)

    # 3. è¿”å›è½¬å½•ç»“æœ
    # return transcription

    # å½“å‰ä½¿ç”¨ Mock å®ç°
    return "[Mock ASR] è¿™æ˜¯ä¸€æ®µæ¨¡æ‹Ÿçš„è¯­éŸ³è½¬æ–‡æœ¬ç»“æœ"

async def synthesize_speech(self, text: str) -> str:
    """æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰"""

    # TODO: é›†æˆçœŸå®çš„ TTS æ¨¡å‹
    # 1. è°ƒç”¨ TTS æ¨¡å‹
    # audio_bytes = await self.tts_model.synthesize(text)

    # 2. ç¼–ç ä¸º base64
    # return base64.b64encode(audio_bytes).decode('utf-8')

    # å½“å‰ä½¿ç”¨ Mock å®ç°
    mock_audio = b"MOCK_AUDIO_DATA"
    return base64.b64encode(mock_audio).decode('utf-8')
```

å‚è€ƒ `try/` ç›®å½•ä¸­çš„ ASR å’Œ TTS å®ç°ã€‚

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Uvicorn æ–‡æ¡£](https://www.uvicorn.org/)
- [WebSockets æ–‡æ¡£](https://websockets.readthedocs.io/)
- [Ollama æ–‡æ¡£](https://ollama.ai/docs)
- [LangChain æ–‡æ¡£](https://python.langchain.com/)

### GPU Server ç›¸å…³

- [GPU Server README](gpuserver/README.md)ï¼šè¯¦ç»†çš„å®‰è£…å’Œé…ç½®è¯´æ˜
- [LLM README](gpuserver/llm/README.md)ï¼šLLM æ¨¡å—çš„è¯¦ç»†è¯´æ˜
- [æµ‹è¯•è„šæœ¬](gpuserver/temp/tests/)ï¼šåŠŸèƒ½æµ‹è¯•ç¤ºä¾‹

### å‚è€ƒå®ç°

- `try/llm/`ï¼šLLM é›†æˆå‚è€ƒå®ç°
- `try/rag/`ï¼šRAG æ£€ç´¢å‚è€ƒå®ç°
- `try/tts/`ï¼šTTS å‚è€ƒå®ç°
- `try/lip-sync/`ï¼šMuseTalk å‚è€ƒå®ç°

---

**æœ€åæ›´æ–°**ï¼š2025-12-23
