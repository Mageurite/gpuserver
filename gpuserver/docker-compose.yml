version: '3.8'

services:
  gpu-server:
    build: .
    container_name: gpu-server
    # 使用宿主机网络模式，可以访问 Tailscale 虚拟网卡
    network_mode: "host"
    environment:
      # API 配置
      - MANAGEMENT_API_HOST=0.0.0.0
      - MANAGEMENT_API_PORT=9000
      # WebSocket URL (使用 Tailscale IP)
      # 注意：部署时需要替换为实际的 Tailscale IP
      - WEBSOCKET_URL=ws://<TAILSCALE_IP>:9000
      # GPU 配置
      - CUDA_VISIBLE_DEVICES=0
      # 会话配置
      - MAX_SESSIONS=10
      - SESSION_TIMEOUT_SECONDS=3600
    volumes:
      # 日志持久化
      - ./logs:/app/logs
      # 如果需要使用本地模型文件
      # - ./models:/app/models
    restart: unless-stopped
    # GPU 支持（如果需要）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # 可选：添加健康检查服务
  healthcheck:
    image: curlimages/curl:latest
    container_name: gpu-server-healthcheck
    network_mode: "host"
    command: >
      sh -c "while true; do
        curl -f http://localhost:9000/health || exit 1;
        sleep 30;
      done"
    depends_on:
      - gpu-server
    restart: unless-stopped
